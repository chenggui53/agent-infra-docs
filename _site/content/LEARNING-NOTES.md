# OpenClaw Agent Sandbox 学习笔记

## 核心学习要点

### 1. 沙箱机制的核心目标
OpenClaw 沙箱的主要目标是**隔离和限制工具执行环境**，减少潜在的安全风险，特别是在处理不可信内容或多代理场景下。

### 2. 沙箱与主机执行的区别
- **主机执行**: 工具直接在你的电脑上运行，有完全的系统访问权限
- **沙箱执行**: 工具在 Docker 容器中运行，资源受限，安全边界清晰

### 3. 沙箱模式的选择
- **"off"**: 无沙箱，适合个人使用，完全控制
- **"non-main"**: 仅非主会话沙箱化，适合群组聊天
- **"all"**: 所有会话沙箱化，适合高安全性要求

## 配置关键点

### 4. 工具政策的重要性
工具政策是沙箱安全的核心，决定了哪些工具可以在沙箱中运行。建议：
- 使用最小权限原则
- 优先使用 deny 规则
- 了解工具组简化配置

### 5. 工作区访问控制
- **"none"**: 沙箱有独立的工作区（最安全）
- **"ro"**: 只读访问，适合需要读取文件但不修改的场景
- **"rw"**: 读写访问，需要谨慎使用

### 6. 容器范围的影响
- **"session"**: 每个会话一个容器，完全隔离（推荐）
- **"agent"**: 每个代理一个容器，共享资源
- **"shared"**: 所有会话共享一个容器，资源效率最高但隔离最少

## 高级配置技巧

### 7. 自定义绑定挂载
```json5
"binds": ["/home/user/source:/source:ro"]
```
- 可以挂载额外的目录到沙箱中
- 建议使用 `:ro` 只读模式
- 避免挂载敏感系统目录

### 8. 沙箱初始化命令
```json5
"setupCommand": "apt-get update && apt-get install -y python3"
```
- 容器创建时运行的一次性命令
- 可用于安装依赖
- 注意网络和权限限制

### 9. 浏览器沙箱
```json5
"browser": {
  "autoStart": true,
  "autoStartTimeoutMs": 30000
}
```
- 沙箱内的浏览器实例
- 与主浏览器隔离
- 适合安全测试和网页访问

## 安全最佳实践

### 10. 多代理配置策略
```json5
"agents": {
  "list": [
    { "id": "main", "sandbox": { "mode": "off" } },
    { "id": "public", "sandbox": { "mode": "all" } }
  ]
}
```
- 个人代理无沙箱，公共代理严格沙箱
- 根据使用场景分配不同的安全级别

### 11. 防止容器逃逸
```json5
"readOnlyRoot": true,
"network": "none"
```
- 只读根文件系统
- 禁止网络访问
- 最小化容器权限

### 12. Elevated 模式控制
```json5
"elevated": {
  "enabled": false
}
```
- 完全禁用主机执行
- 适用于高安全性代理

## 调试与监控

### 13. 沙箱解释器
```bash
openclaw sandbox explain
```
- 显示沙箱配置详情
- 解释工具访问权限
- 提供修复建议

### 14. 容器管理
```bash
docker ps --filter "name=openclaw-sbx-"
```
- 列出运行中的沙箱容器
- 查看容器状态
- 清理旧容器

### 15. 日志监控
```bash
tail -f logs/gateway.log | grep -E "routing|sandbox|tools"
```
- 监控沙箱相关事件
- 分析工具执行问题
- 调试权限相关错误

## 常见问题

### 16. 工具被阻止
- **问题**: 工具在沙箱中无法使用
- **解决**: 检查工具政策，使用 `openclaw sandbox explain` 定位问题

### 17. 工作区不可访问
- **问题**: 工具无法读取工作区文件
- **解决**: 检查 `workspaceAccess` 配置，确认路径权限

### 18. 沙箱未启用
- **问题**: 代理没有按照预期进入沙箱
- **解决**: 检查 `sandbox.mode` 配置，确认代理身份识别正确

## 未来学习路径

### 19. 深入研究方向
- Docker 容器安全
- 沙箱逃逸技术
- 工具政策优化

### 20. 实战练习
- 配置不同安全级别的代理
- 测试工具政策限制
- 监控沙箱运行状态

---

**学习进度**: 
- ✅ 基础概念掌握
- ✅ 配置文件编写
- ✅ 常见场景应用
- 🔄 高级功能探索

**下一步**: 实际测试配置，优化工具政策
